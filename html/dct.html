<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="Sample illustrating the use of Web Bluetooh / Get Characteristics.">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Web Bluetooth</title>
<style type="text/css">
#ind button{
	height:40px;
  width:100px;
  font-size:1.0em;
}
#ind th{
	height:40px;
  font-size:0.8em;
}
#control button{
	width:100%;
	height:50px;
  font-size:1.0em;
}
#control td{
	width:100px;
}
#output{
  font-size:0.8em;
}
.comment{
	font-size:8pt;
}
</style>
<script src="//code.jquery.com/jquery-3.3.1.min.js" type="text/javascript"></script>
</head>

<body>
<button id="discon">切断</button><button id="set0">SET-0</button><br clear="all">
<div style="width:100%;height:400px;background-color:ivory">
<canvas id="plot" style="width:100%;height:100%;background-color:ivory" ></canvas>
</div>
<div>
<table id="control">
<tr><td rowspan="4"><button id="write">送信</button><td rowspan="4"><button id="cancel">キャンセル</button><td rowspan="4">
<tr><td><td rowspan="2"><button id="up">↑</button>
<tr><td rowspan="2"><button id="left">←</button><td rowspan="2"><button id="right">→</button>
<tr><td rowspan="2"><button id="down">↓</button>
</table>
</div>
</div>
<br clear="all">
<table id="ind" border>
<tr><td><button id="connect">接続</button><th id="ind_dev">Device<th id="ind_srv">Server<th id="ind_svc">Service<th id="ind_adsok">Ads<th id="ind_woutok">Wout<td>&nbsp;&nbsp;<th id="ind_pup">P-UP<th id="ind_pdw">P-DW<th id="ind_wup">W-UP
</table>

<table id="rom" border></table>

<h3>Debugging</h3>
<div id="output"></div>

<script type="module">
//Defaut param//
let Param=[
  [90,7,50,50,100,20,200,0,0,30,150,30,150,0,255,0,
  40,10,0,0,35,0,0,0,0,240,25,240,45,200,65,150,
  98,102,142,89,200,40,255,40,0,50,100,100,200,200,255,255,
  0,0,10,0,50,0,255,0,
  0,30,20,242,10,255,255,255,120,133,5,2,0,255,128,255,
  100,23,100,255,255,166,133,96,255,5,5,255,255,255,255,255,
  255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
  255,0,1,255,255,255,255,255]
];
let ParamBuf=[];

//BLE UUIDs///
import BTLE from "./btle.js";
BTLE.serviceUuid='10014246-f5b0-e881-09ab-42000ba24f83';
BTLE.charAdsUuid='20024246-f5b0-e881-09ab-42000ba24f83';
BTLE.charNotifUuid='20054246-f5b0-e881-09ab-42000ba24f83';

function isWebBluetoothEnabled(){
	if(navigator.bluetooth){
		return true;
	}
	else{
		console.log('Web Bluetooth API is not available.\n' +'Please make sure the "Experimental Web Platform features" flag is enabled.');
		return false;
	}
}

function resetInd(){
  $('#ind th').css({'background':'grey'});
}

let writeQueue=[];

let canvas,context;

const BrkTbl=24;
let BrkX=[];
let BrkY=[];
let BrkC=-1;
let WavX=[];
let WavY1=[];
let WavY2=[];
let WavY3=[];
let RangeX=[0,800];
let RangeY1=[0,6*1000];
let RangeY2=[-3*100,3*100];
let RangeY3=[-3*1000,3*1000];
let RangeB=[0,6*100];

function drawAll(){
  gridPlot(8,6);
	graphPlot(WavX,WavY1,RangeX,RangeY1,'green');
  graphPlot(WavX,WavY2,RangeX,RangeY2,'red');
  graphPlot(WavX,WavY3,RangeX,RangeY3,'blue');
  polyPlot(BrkX,BrkY,RangeX,RangeB,'blue');
  circlePlot(BrkX[BrkC],BrkY[BrkC],RangeX,RangeB,6,'blue');
  textPlot(BrkX[BrkC],BrkY[BrkC],RangeX,RangeB,BrkX[BrkC]+','+BrkY[BrkC],'blue');
}
function BrkReload(){
  for(let i=0;i<8;i++){
    let x=Number($('#rom input').eq(2*i+BrkTbl).val());
    BrkY[i]=$('#rom input').eq(2*i+BrkTbl+1).val();
    BrkX[i]=Math.floor(x+x*x/128);
  }
}

$(document).ready(function(){
	if('serviceWorker' in navigator){
		navigator.serviceWorker.register('service-worker.js');
	}
  resetInd();
  canvas=$("#plot").get(0);
  context=canvas.getContext('2d');
  canvas.width=$('#plot').width();
  canvas.height=$('#plot').height();
  drawAll();

	const column=8;
	let tbl='';
	for(let i=0;i<112/column;i++){
		let row=column*i;
		tbl+='<tr><td align="right">'+row+'</td>';
		for(let j=0;j<column;j++){
			let idx=row+j;
			tbl+='<td><input type="text" style="width:100%;" maxlength="3"></input></td>';
		}
		tbl+='</tr>';
	}
	$('#rom').append(tbl);
  let colorMark=$('#rom input').css('color');

	$('#connect').click(function(event){
		if(isWebBluetoothEnabled()) {
			BTLE.ready();
		}
	});
	$('#discon').click(function(event){
		BTLE.discon();
	});
	$('#set0').click(function(event){
    let par=ParamBuf=Param[0].clone();
    for(let i=0;i<par.length;i++){
      let tg=$('#rom input').eq(i);
      tg.val(par[i]);
      tg.css({'color':'red'});
    }
	});
	$('#plot').click(function(event){
    let x=event.pageX-$(event.target).offset().left;
    let y=event.pageY-$(event.target).offset().top;
    let dist=canvas.width*canvas.width+canvas.height*canvas.height;
    for(let i=0;i<BrkX.length;i++){
      let p=coordPlot(BrkX[i],BrkY[i],RangeX,RangeB);
      let d=(x-p.x)*(x-p.x)+(y-p.y)*(y-p.y);
      if(dist>d){
        BrkC=i;
        dist=d;
      }
    }
    drawAll();
	});
  $('#up').click(function(event){
    if(BrkC>=0){
      let y=Math.floor(BrkY[BrkC]*1.05);
      if(y>255) y=255;
      if(BrkY[BrkC]<y) BrkY[BrkC]=y;
      else BrkY[BrkC]++;
      let tg=$('#rom input').eq(2*BrkC+BrkTbl+1);
      tg.val(BrkY[BrkC]);
  		tg.css({'color':'red'});
      drawAll();
    }
  });
  $('#down').click(function(event){
    if(BrkC>=0){
      let y=Math.floor(BrkY[BrkC]*0.95);
      if(BrkY[BrkC]>y) BrkY[BrkC]=y;
      else if(y>0) BrkY[BrkC]--;
      let tg=$('#rom input').eq(2*BrkC+BrkTbl+1);
      tg.val(BrkY[BrkC]);
  		tg.css({'color':'red'});
      drawAll();
    }
  });
  $('#left').click(function(event){
    if(BrkC>0 && BrkC<7){
      let x1=BrkX[BrkC]*0.95;
      let x2=Math.floor(-64+8*Math.sqrt(64+2*x1));
      let x3=Math.floor(x2*x2/128+x2);
      if(BrkX[BrkC]>x3) BrkX[BrkC]=x3;
      else BrkX[BrkC]--;
      let tg=$('#rom input').eq(2*BrkC+BrkTbl);
      tg.val(Math.floor(-64+8*Math.sqrt(64+2*BrkX[BrkC])))
  		tg.css({'color':'red'});
      drawAll();
    }
  });
  $('#right').click(function(event){
    if(BrkC>0 && BrkC<7){
      let x1=BrkX[BrkC]*1.05;
      let x2=Math.floor(-64+8*Math.sqrt(64+2*x1));
      let x3=Math.floor(x2*x2/128+x2);
      if(BrkX[BrkC]<x3) BrkX[BrkC]=x3;
      else BrkX[BrkC]++;
      let tg=$('#rom input').eq(2*BrkC+BrkTbl);
      tg.val(Math.floor(-64+8*Math.sqrt(64+2*BrkX[BrkC])))
  		tg.css({'color':'red'});
      drawAll();
    }
  });
	$('#rom input').change(function(e){
	  let en=$('#rom input').index(e.target);
	  let tg=$(e.target);
		let v=tg.val();
		if(v>255) tg.val(v=255);
		else if(v<0) tg.val(v=0);
		tg.css({'color':'red'});
  });
  function checkQueue(){
    let queue=[];
    $('#rom input').each(function(i,e){
      if($(e).css('color')!=colorMark){
    		let v=$(e).val();
    		if(v>255) $(e).val(v=255);
    		else if(v<0) $(e).val(v=0);
        let rq={'address':i,'value':v};
        queue.push(rq);
      }
    });
    return queue;
  }
  $('#write').click(function(event){
    writeQueue=checkQueue();
    if(writeQueue.length>0){
      if(BTLE.link){
        let q=writeQueue.shift();
        BTLE.write3(0xA000|q.address,q.value);
        $('#ind_pdw').css({'background':'orange'});
      }
      else BTLE.ready();
    }
  });
  $('#cancel').click(function(event){
    for(let i=0;i<ParamBuf.length;i++){
  	  let tg=$('#rom input').eq(i);
      tg.val(ParamBuf[i]);
      tg.css({'color':''});
    }
    BrkReload();
    drawAll();
  });

  BTLE.on('ready',function(){
    console.log('BLE ready');
    this.write2(0xFC01);//wave upload req
    $('#ind_wup').css({'background':'orange'});
    const who=this;
    this.on('wdone',function(){
      $('#ind_wup').css({'background':'grey'});
      console.log('Wave received, try upload or write parameter');
      writeQueue=checkQueue();
      if(writeQueue.length==0){
        who.write2(0xFA01); //parameter upload req
        $('#ind_pup').css({'background':'orange'});
        who.timeout=setTimeout(function(){
          $('#ind_pup').css({'background':'grey'});
        },500);
      }
      else{
        let q=writeQueue.shift();
        who.write3(0xA000|q.address,q.value);
        $('#ind_pdw').css({'background':'orange'});
        who.timeout=setTimeout(function(){
          $('#ind_pdw').css({'background':'grey'});
        },500);
      }
      who.off('wdone');
    });
    this.timeout=setTimeout(function(){
      console.log('No wave received');
      who.emit('wdone');
    },500);
  });
  BTLE.on('disconnect',function(){
    resetInd();
  });
  BTLE.on('error',function(err){
    resetInd();
    console.log('btle err:'+err);
  });
  BTLE.on('connect',function(err){
    $('#ind_dev').css({'background':'cyan'});
  });
  BTLE.on('server',function(){
    $('#ind_srv').css({'background':'cyan'});
  });
  BTLE.on('service',function(){
    $('#ind_svc').css({'background':'cyan'});
  });
  BTLE.on('woutok',function(){
    $('#ind_woutok').css({'background':'cyan'});
  });
  BTLE.on('adsok',function(){
    $('#ind_adsok').css({'background':'cyan'});
  });
  BTLE.timeout=null;
  BTLE.wrevs=1000;
  BTLE.on('receive',function(data){
    let des=data.getUint16(0);
    let det=des&0xF000;
//    console.log('data.length='+data.byteLength+' [0]'+des);
    if(this.timeout!=null) clearTimeout(this.timeout);
    if(det==0){
      if(this.wrevs>des){
        WavX=[]; WavY1=[]; WavY2=[]; WavY3=[];
        $('#ind_wup').css({'background':'orange'});
    }
      WavX.push(this.wrevs=des);
//    WavX.push(data.getUint16(2));
      WavY1.push(Math.PI*2e6/data.getUint16(4));
      WavY2.push(data.getUint16(6));
      WavY3.push(data.getInt16(8));
      let who=this;
      this.timeout=setTimeout(function(){
        console.log('wave received '+WavX.length);
        $('#ind_wup').css({'background':'grey'});
        who.emit('wdone');
        drawAll();
        who.timeout=null;
      },300);
    }
    else if(det==0xB000){  //Param read (max.8 bytes)
      let key=des&0xFFF;
      let len=data.byteLength;
      for(let i=2;i<len;i++,key++){
        let tg=$('#rom input').eq(key);
        let val=data.getUint8(i);
        tg.val(val);
      	tg.css({'color':''});
        ParamBuf[key]=val;
			}
      let who=this;
      this.timeout=setTimeout(function(){
        console.log('parameter received');
        BrkReload();
        $('#ind_pup').css({'background':'grey'});
        drawAll();
        who.timeout=null;
      },300);
    }
    else if(det==0xA000){
      let key=des&0xFFF;
      console.log('write verify:'+key);
      if(key!=0xFFF){
        let tg=$('#rom input').eq(key);
        tg.css({'color':''});
        ParamBuf[key]=tg.val();
      }
      if(writeQueue.length>0){
        let q=writeQueue.shift();
        BTLE.write3(0xA000|q.address,q.value);
      }
      else $('#ind_pdw').css({'background':'grey'});
    }
  });
});



////Plotting////
const marginPlot=30;
const gridPlot=function(xn,yn){
  let w=canvas.width-2*marginPlot;
  let h=canvas.height-2*marginPlot;
	context.clearRect(0,0,canvas.width,canvas.height);
	context.lineWidth=1.0;
	context.strokeStyle='#444444';
	for(var i=0;i<=xn;i++){
		context.beginPath();
		context.moveTo(w/xn*i+marginPlot,marginPlot);
		context.lineTo(w/xn*i+marginPlot,canvas.height-marginPlot);
		context.stroke();
	}
	for(var i=0;i<=yn;i++){
		context.beginPath();
		context.moveTo(marginPlot,h/yn*i+marginPlot);
		context.lineTo(canvas.width-marginPlot,h/yn*i+marginPlot);
		context.stroke();
	}
}
const graphPlot=function(xw,yw,xr,yr,col){
	context.lineWidth=1.0;
	context.strokeStyle=col;
	context.beginPath();
	for(var i=0;i<xw.length;i++){
    let p=coordPlot(xw[i],yw[i],xr,yr);
		if(i==0) context.moveTo(p.x,p.y);
		else context.lineTo(p.x,p.y);
	}
	context.stroke();
}
const polyPlot=function(xw,yw,xr,yr,col){
	context.lineWidth=1.0;
	context.strokeStyle=col;
	context.beginPath();
	for(var i=0;i<xw.length;i++){
    let p=coordPlot(xw[i],yw[i],xr,yr);
		if(i==0) context.moveTo(p.x,p.y);
		else context.lineTo(p.x,p.y);
	}
	context.stroke();
	for(var i=0;i<xw.length;i++){
    circlePlot(xw[i],yw[i],xr,yr,3,col);
	}
}
const circlePlot=function(xw,yw,xr,yr,rad,col){
	context.fillStyle=col;
	context.beginPath();
  let p=coordPlot(xw,yw,xr,yr);
  context.arc(p.x,p.y,rad,0,2*Math.PI,true);
  context.fill();
	context.stroke();
}
const textPlot=function(xw,yw,xr,yr,str,col){
	context.fillStyle=col;
	context.font="20px";
  let p=coordPlot(xw,yw,xr,yr);
  context.fillText(str,p.x-20,p.y-20);
	context.stroke();
}
const coordPlot=function(xw,yw,xr,yr){
  let w=canvas.width-2*marginPlot;
  let h=canvas.height-2*marginPlot;
  return {
    x:(xw-xr[0])/(xr[1]-xr[0])*w+marginPlot,
	  y:h-(yw-yr[0])/(yr[1]-yr[0])*h+marginPlot
  };
}


</script>

</body>
</html>
