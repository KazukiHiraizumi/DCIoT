<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="Sample illustrating the use of Web Bluetooh / Get Characteristics.">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Web Bluetooth</title>
<style type="text/css">
th button{
	width:100%;
	height:40px;
}
.comment{
	font-size:8pt;
}
</style>
<script src="jquery.js" type="text/javascript"></script>
</head>

<body>
<button id="connect">接続</button>
<button id="notif">ノーティファイ</button>
<button id="discon">切断</button>
<button id="log">ログ</button>
<button id="clrlog">ログクリア</button>

<h3>Live Output</h3>
<div id="output"></div>

<script>

const serviceUuid='10014246-f5b0-e881-09ab-42000ba24f83';
const charAdsUuid='20024246-f5b0-e881-09ab-42000ba24f83';
const charDinUuid='20034246-f5b0-e881-09ab-42000ba24f83';
const charDoutUuid='20044246-f5b0-e881-09ab-42000ba24f83';
const charWoutUuid='20054246-f5b0-e881-09ab-42000ba24f83';

const ab2str = function(buf) {
  let bufView = new Uint8Array(buf);
  return String.fromCharCode.apply(null, bufView);
}
const str2ab = function(str) {
  let encodedString = unescape(encodeURIComponent(str));
  let bytes = new Uint8Array(encodedString.length);
  for (let i=0;i<encodedString.length;++i){
    bytes[i]=encodedString.charCodeAt(i);
  }
  return bytes.buffer;
}

let BTLE={
	gatt:null,service:null,cread:null,cwrite:null,output:null,
	discon:function(){
		if(this.gatt==null){
			$('#output').append('No GATT to disconnect');
		}
		else{
			this.gatt.disconnect();
		}
	},
	getS:async function(){
		try{
			$('#output').append('Requesting Bluetooth Device...<br>');
			const device=await navigator.bluetooth.requestDevice({
//				filters: [{services: [serviceUuid]}
				filters: [{name: 'Shimano'}]
//				optionalServices: [serviceUuid]
			});
			$('#output').append('Device: '+device+'<br>');
			device.addEventListener('gattserverdisconnected',function(event){
				$('#output').append('Device disconnected<br>');
			});
			this.gatt=device.gatt;
			const server=await device.gatt.connect();
			$('#output').append('Server: '+server+'<br>');
			this.service=await server.getPrimaryService(serviceUuid);
			$('#output').append('Service: '+this.service+'<br>');
		}
		catch(error) {
			$('#output').append('Argh! '+error+'<br>');
		}
	},
	reconS:async function(){
		try{
			const server= await this.gatt.connect();
			$('#output').append('Gatt Recconected<br>');
			this.service=await server.getPrimaryServices(serviceUuid);
			$('#output').append('Service gotten '+service+'<br>');
		}
		catch(error){
			$('#output').append('Argh! '+error+'<br>');
		}
	},
	bufDout:null,
	queueDout:0,
	setDout:async function(){
		let nchar=null;
		$('#output').append('Try notification on');
		this.bufDout=[];
		try{
			const characteristic=await this.service.getCharacteristic(charDoutUuid);
			nchar=characteristic;
			await nchar.startNotifications();
			nchar.addEventListener('characteristicvaluechanged',function(event){
				if(this.queueDout>0) clearTimeout(this.queueDout);
				this.bufDout.push(event.target.value.getUint8(0));
				this.queueDout=setTimeout(function(){
					$('#output').append('Dout callback<br>');
					this.bufDout.forEach(function(elm){
						$('#output').append(elm+'<br>');
					});
					this.queueDout=0;
				},300);
			});
		}
		catch(error){
			$('#output').append('Argh! '+error+'<br>');
//			if(nchar!=null){
//				nchar.addEventListener('characteristicvaluechanged',notiDout);
//			}
		}
	},
	bufWout:[],
	queueWout:0,
	setWout:async function(){
		let scope=this;
		let nchar=null;
		$('#output').append('Try notification on');
		try{
			const characteristic=await this.service.getCharacteristic(charWoutUuid);
			nchar=characteristic;
			await nchar.startNotifications();
			nchar.addEventListener('characteristicvaluechanged',function(event){
console.log('Wout CB');
				if(scope.queueWout>0) clearTimeout(scope.queueWout);
				let value=event.target.value;
				for(let i=0;i<value.byteLength;i+=2){
					scope.bufWout.push(value.getUint16(i));
				}
				scope.queueWout=setTimeout(function(){
					$('#output').append('Wout callback<br>');
					scope.bufWout.forEach(function(elm){
						$('#output').append(elm+'<br>');
					});
					scope.queueWout=0;
					scope.bufWout=[];
				},300);
			});
		}
		catch(error){
			$('#output').append('Argh! '+error+'<br>');
//			if(nchar!=null){
//				nchar.addEventListener('characteristicvaluechanged',notifCB);
//			}
		}
	},
	writeAds:async function(val){
		$('#output').append('writeA char...'+this.service+'<br>');
		try{
			const characteristic=await this.service.getCharacteristic(charAdsUuid);
			let data=new Uint16Array(1);
			data[0]=val;
			await characteristic.writeValue(data);
		}
		catch(error){
			$('#output').append('Argh! '+error+'<br>');
		}
	},
	writeDin:async function(val){
		$('#output').append('writeD char...'+this.service+'<br>');
		try{
			const characteristic=await this.service.getCharacteristic(charDinUuid);
			const data=new Uint8Array(1);
			data[0]=val;
			await characteristic.writeValue(data);
		}
		catch(error){
			$('#output').append('Argh! '+error+'<br>');
		}
	}
}

function isWebBluetoothEnabled(){
	if(navigator.bluetooth){
		return true;
	}
	else{
		$('#output').append('Web Bluetooth API is not available.\n' +'Please make sure the "Experimental Web Platform features" flag is enabled.');
		return false;
	}
}


$(document).ready(function(){
	if('serviceWorker' in navigator){
		navigator.serviceWorker.register('service-worker.js');
	}
	$('#connect').click(function(event){
		if(isWebBluetoothEnabled()) {
			BTLE.getS();
		}
	});
	$('#notif').click(function(event){
		BTLE.setWout();
	});
	$('#log').click(function(event){
		BTLE.writeAds(0x1234);
	});
	$('#discon').click(function(event){
		BTLE.discon();
	});
	$('#clrlog').click(function(event){
		$('#output').empty();
	});
});
</script>

</body>
</html>
