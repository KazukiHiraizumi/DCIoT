<meta http-equiv="Content-Script-Type" content="text/javascript">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<html>
<head>
<title>Firmware Specificatio</title>
<script type="text/javascript" src="http://www.c-able.ne.jp/~hirai551/jquery.js"></script>
<link rel="stylesheet" type="text/css" href="http://www.c-able.ne.jp/~hirai551/carp.css" />
<style>
div{margin-bottom:1em;}
LI{
	line-height:1.3em;
}
P.PB{
    page-break-before:always;
}
TABLE.small {
	font-size:9pt;
}
</style>
</head>
<body>
<h1>BFデバイス／ファームウェア仕様 rev2.2</h1>
<hr>
<div align="right">2016/6 (株)ワークソリューション</div>
<h2>BLEサービス</h2>
<h3>標準サービス</h3>
<ol>
<li>Generic Access/0x1800
<li>Battery/0x180F
</ol>
<h3>BFデバイス固有サービス</h3>
<table border>
<tr><th>Name<th>ID
<tr><td>BF Device<td>10014246-0000-1000-8000-00805F9B34FB
</table>
<h4>キャラクタリスティック</h4>
<h5>1.履歴情報の取得</h5>
<table border>
<tr><th><th>Name<th>ID<th>Notify<th>Attribute Values<th>R/W<th>Value range
<tr><td rowspan="2">1<td rowspan="2">履歴情報の取得<td rowspan="2">20014246-0000-1000-8000-00805F9B34FB<td rowspan="2">Yes<td>履歴番号<td>W<td>10進文字列
<tr><td>履歴情報<td>R<td>履歴情報文字列
</table>
<ol>
<li>履歴番号
<p>デバイスには、過去120回の錠剤有無状態の変化とそのタイムスタンプが記憶されています。このうち最新から25回分<sup>(1)</sup>は、不揮発メモリーに保存されており、電池を取り外しても消失しません。この情報にアクセスするには、まずこのアトリビュート値に履歴番号を書き込みます。履歴番号は'0'が最も新しい情報で、'1','2'…の順に過去情報となります。
<div>(注1)24錠以下のシートでは30回分が保存されます。</div>
<li>履歴情報
<p>このアトリビュート値の読み出しは、履歴番号にて指定された次の２つの履歴情報を表しています。
<ol>
<li>タイムスタンプ(UNIX時刻10進文字列)
<li>錠剤有無ビットパタン(HEX文字列)
</ol>
<p>それぞれの情報は'/'文字にて区切られています。指定された履歴番号の情報が無かった場合は、タイムスタンプとして'0'が読み出されます。<br>
錠剤有無ビットパタンは、シートの全ての位置の錠剤の有無を示すコードです。錠剤有り＝１、無し＝０とし、1日目の位置をLSBとした16進数にて表現しています。
<dl><dt>例/UNIX時刻2015年1月1日00:00:00、錠剤5個無<dd>1451574000/1F</dl>
</ol>

<h5>3.デバイス状態の取得</h5>
<table border>
<tr><th><th>Name<th>ID<th>Notify<th>Attribute Values<th>R/W<th>Value range
<tr><td rowspan="2">3<td rowspan="2">デバイス状態の取得<td rowspan="2">20034246-0000-1000-8000-00805F9B34FB<td rowspan="2">Yes<td>取得情報の指定<td>W<td>アルファベット1文字[+数値文字列]
<tr><td>デバイス状態<td>R<td>デバイス状態文字列
</table>
<p>このキャラクタリスティックはデバイスの現在の状態値を読み出します。どの状態値を読み出すかは、対応する「取得情報の指定文字列」を書き込むことによって決まります。デバイスの以下の情報を取得することができます。
<div style="margin-left:50px;"><table border>
<tr><th>指定文字列<th>状態値<th>読出書式
<tr><td>Cnn(nnはセル番号)<td>各セルのセンサーレベル情報<td>現在の受光レベル/出荷時Lowレベル/出荷時Lowレベル<br>例) 100/10/200
<tr><td>U<td>現在時タイマー<td>10進文字列<br>例) 1451574000
<tr><td>E<td>錠剤有無ビットパタン<td>HEX文字列<br>例) 1FF
<tr><td>L<td>カバー開閉<td>文字列'OPEN'または'CLOSE'
<tr><td>B<td>バッテリレベル<td>10進文字列<br>例) 90
</table></div>
<h5>4.デバイスの設定</h5>
<table border>
<tr><th><th>Name<th>ID<th>Notify<th>Attribute Values<th>R/W<th>Value range
<tr><td>4<td>デバイスの設定<td>20044246-0000-1000-8000-00805F9B34FB<td>-<td>デバイス設定<td>W<td>アルファベット1文字+数値文字列
</table>
<p>デバイス設定キャラクタリスティックはデバイスの様々な設定をするリクエストです。このキャラクタリスティックは書き込みのみで、アトリビュート値は１文字のアルファベットで示されるパラメータの種類とそれに続く数値文字列です。以下が設定できるパラメータです。
<ol>
<li>現在時刻タイマー
<p>BFデバイスは秒単位で自動的に増加する32ビットのタイマーを提供しています。このタイマーに現時刻のUNIXタイムスタンプを設定することで現在時刻を示すタイマーとして機能します。設定する値は1451606400(2016/1/1 0:0:0 GMT)より大きい数値でなければなりません。これより小さな値は無効な入力として受付けません。なお、タイマーの現在値は、"デバイス状態の取得"の状態番号3にて知ることができます。
<p>またこのタイマーは履歴記録のタイムスタンプに用いられるので、正しい記録のためにはアプリは定期的に再設定する必要があります。
<p>このタイマーに数値を設定するコマンド文字は'U'、数値は10進文字列で与えます。
<dl><dt>例/UNIX時刻2016年1月1日0:0:0GMT(1451606400)を設定<dd>U1451606400</dl>
<li>センサー閾値
<p>錠剤のありなし判定のためのHi/Lo間の閾値を設定します。この値を設定するコマンド文字は'H'です。
<dl><dt>例/閾値を50%を設定<dd>H50</dl>
<li>テスト履歴入力
<p>錠剤有無ビットパタンのテスト履歴を生成します。入力されたビットパタンはタイムスタンプとともに記録され、実際の錠剤有無検出履歴と全く同様に参照することができます。この処理を行うコマンド文字は'P'、それに続けビットパタンを16進文字列にて与えます。
<dl><dt>例1/錠剤1?10無し履歴を生成<dd>P3FF<dt>例2/錠剤全部あり履歴を生成<dd>P0</dl>
<li>初期化・自己診断機能
<p>デバイスにはテストや出荷検査に用いる機能が用意されています。この処理を行うコマンド文字は'S'で、特定のコードにて機能を指定します。
<ol>
<li>S10007/履歴消去
<p>NVM(不揮発メモリ)に記憶されている履歴を消去します。
<dl><dt>例/履歴消去<dd>S10007</dl>
<li>S10009/S10007に同じ
<li>S10037/センサーLOWレベル記憶
<p>すべてのセルのセンサーレベルを計測し錠剤有レベル値(光センサーLoレベル)としてNVMに記憶します。これは出荷時調整のための機能なのでの、それ以外の目的で呼び出さないこと。
<li>S10039/スリープタイマー補正
<p>スリープタイマー(約１秒周期)を計測し、補正値をNVMに記憶します。これは出荷時調整のための機能なのでの、それ以外の目的で呼び出さないこと。
</ol>
<p class="PB" />
<li>フラグ設定
<p>デバイスのデフォルト動作を変えるためのフラグが用意されています。この処理を行うコマンド文字は'W'、それに続くフラグ番号10進文字、さらに続くフラグ値16進文字列で与えます。
<dl><dt>例/フラグ0のビット0とビット5をセットする。<dd>W021</dl>
<ol>
<li>フラグ０／ビーコン制御
<table border>
<tr><th>ビット<th>機能<th>初期値<th>デバイス動作
<tr><td>0<td>ビーコン検出<td>0<td>初期状態(電池交換直後)ではデバイスからのビーコンは誰でも検出できます。<br>このビットが0のときは、一度デバイスに接続すると、２回目からはその機器同士しかビーコンを検出できなくなります。<sup>(1)</sup><br>このビットが1のときは、２回目以降も誰もがビーコンを検出できます。
<tr><td>1<td>ビーコンLED<td>1<td>このビットが1のときは、ビーコン送出中にLEDを点滅させます。
<tr><td>2<td>条件ビーコン有効<td>1<td>このビットが0のときは、ビーコンは常時送出されます。<br>このビットが1のときは、以下の条件成立時のみ送出されます。
<tr><td>3<td>条件ビーコン①<br>未読ビーコン<td>0<td>未読の履歴がデバイスに残っているときのビーコンの送出方法を設定します。<br>このビットが0のときは、未読履歴が無くなるまでビーコンを送出します。<br>このビットが1のときは、最大１時間ビーコンを送出します。
<tr><td>4<td>条件ビーコン②<br>カバー開ビーコン<td>0<td>カバーを開き動作時のビーコンの送出方法を設定します。カバー開き動作により、条件ビーコン①の設定に従ったビーコン送出を再開します。<br>このビットが0のときは、条件ビーコン①不成立時も最大３分間ビーコンを送出します。<br>このビットが1のときは条件不成立時はビーコンを送出しません。
</table>
<div>(注1)ビーコンの隠蔽機能は現ファームウェア(2016.5.25)では無効となっています。</div>
</ol>
<p class="PB" />

<h2>デバイスとの接続・通信について</h2>
<font color="blue"><h3>ペアリング</h3>
<p>BLEのレベルでのペアリングにはパスキーが必要なため、本デバイスはこれを採用していません。ペアリングに代わるセキュリティとして、ボンディングとファームウェアのレベルでチップIDの照合を行っています。
<h3>ボンディング</h3>
<p>デバイスはリセットされて最初に接続された端末に対してボンディングを行います。ボンディングのリクエストは、端末側ではペアリングと同様のメッセージが表示されますが、パスキーの入力は必要ありません。端末側でペアリング(実質はボンディング)を承認すると、相互に48ビットのBLEチップのIDが記憶されます。
<h3>再接続とセキュリティ</h3>
<p>BLEはボンディングされた機器以外にビーコンを検出できなくするセキュリティオプションを有しています。しかしながらこの機能は現時点では端末側(iOSなど)でサポートされていないため、次のようなファームウェアによるセキュリティが組み込まれいます。
<p>デバイスのビーコンはボンディングされた端末以外も検出可能であるため、第三者がデバイスに接続する恐れがありますが、デバイスのファームウェアはボンディングされた端末以外は即時に強制切断します。この判断は、接続された端末のチップIDと、先にボンディングしたIDを照合することで行っています。<br>またIDが同じであればファームウェアは所定のBLEサービスを速やかに開始します。よってボンディングされた端末では、このセキュリティの仕組みを意識することなく、デバイスのサービスが機能します。</font>
<h3>切断</h3>
<p>接続状態が続くとデバイスの電池を消耗するため、アプリは必要な処理が終わったら切断するようにしてください。
<h3>トランザクション</h3>
<p>履歴情報、デバイス状態の取得キャラクタリスティクにおいて、目的の情報を取得する手順を、履歴情報取得を例に下記に示します。
<table border>
<tr><th>#<th>アクション<th>例
<tr><th>1<td>履歴番号の書き込み<td>最新の情報を取得するには、デバイスに"0"を書き込みます。
<tr><th>2<td>履歴番号のベリファイ<td>このキャラクタリスティクへの書き込みは、書き込んだ値をエコーバックするACK付き書き込みになっています。Notificationを有効にしていれば、"0"が即時に読み出されます
<tr><th>3<td>履歴情報レディ通知<td>番号に該当する履歴情報を読み出せる状態になると、デバイスからNotificationが受信されます。
<tr><th>4<td>履歴情報読み出し<td>デバイスからのNotificationにより履歴情報を読み出す。
</table>
<p>(注1)1～3までのターンアラウンドタイムは約0.6秒です。Notificationを使わない場合は余裕を持ったWaitを挿入してください。
<p class="PB" />

<h2>内部設計</h2>
<h3>不揮発メモリー割り当て</h3>
<table border>
<tr><th>名称<th>データ数(Bytes)<th>アドレス<th>初期値<th>備考
<tr><td>ビーコン制御フラグ<td>1<td>0<td>6
<tr><td>センサー検出閾値<td>1<td>2<td>10
<tr><td>バッテリ低下限界<td>1<td>3<td>15
<tr><td>バッテリフルレベル<td>1<td>4<td>-<td>S10037コマンドにて更新
<tr><td>スリープタイマー補正値<td>1<td>5<td>125<td>
<tr><td>最新履歴のバッファポインタ<td>1<td>8<td>0<td>
<tr><td>履歴数<td>1<td>9<td>0<td>
<tr><td>履歴バッファ<td>200<td>10-209<td>-<td>
<tr><td>センサーLOWレベル<td>28<td>220-247<td>-<td>S10037コマンドにて更新
</table>

<h3>回路図</h3>
<p>別紙参照

</body>
</html>
